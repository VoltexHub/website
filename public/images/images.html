<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Image Gallery</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
    body {
        margin: 0;
        background: #0f0f0f;
        color: #fff;
        font-family: Arial, sans-serif;
    }

    header {
        width: 100%;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #111;
        position: sticky;
        top: 0;
        z-index: 10;
        padding-right: 40px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .header-left {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }

    .filters-container {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-left: 20px;
        flex-wrap: wrap;
    }

    #search {
        padding: 6px 10px;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 6px;
        color: #fff;
        width: 160px;
    }

    select.filter {
        padding: 6px 10px;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 6px;
        color: #fff;
        min-width: 120px;
    }

    button {
        padding: 7px 14px;
        background: #222;
        border: 1px solid #444;
        border-radius: 6px;
        cursor: pointer;
        color: #fff;
        transition: background 0.2s;
    }

    button:hover {
        background: #333;
    }

    #imageGrid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 25px;
        padding: 20px;
        max-width: 100vw;
        overflow-x: hidden;
        box-sizing: border-box;
    }

    .imgBox {
        background: #1b1b1b;
        padding: 12px;
        border-radius: 14px;
        width: 240px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        position: relative;
        transition: transform 0.2s;
    }

    .imgBox:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .imgBox img, .imgBox video {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 10px;
        cursor: pointer;
    }

    .keywords-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 5px;
    }

    .keywords-label {
        color: #888;
        font-size: 12px;
        white-space: nowrap;
    }

    .keywords-text {
        color: #ccc;
        font-size: 12px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex-grow: 1;
    }

    .bottom-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 5px;
    }

    .stats {
        display: flex;
        gap: 10px;
        align-items: center;
        font-size: 12px;
        color: #888;
    }

    .upload-date {
        font-size: 11px;
        color: #666;
        margin-top: 2px;
    }

    .rating {
        display: flex;
        gap: 4px;
        align-items: center;
        font-size: 14px;
    }

    .rating-number {
        color: #ffd700;
        font-weight: bold;
        margin-right: 5px;
    }

    .rating-stars {
        color: #ffd700;
        letter-spacing: -2px;
    }

    .actions-row {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }

    .action-btn {
        flex: 1;
        padding: 6px 0;
        text-align: center;
        background: #222;
        border: 1px solid #444;
        border-radius: 6px;
        cursor: pointer;
        color: #fff;
        font-size: 12px;
        transition: background 0.2s;
    }

    .action-btn:hover {
        background: #333;
    }

    .action-btn.share {
        background: #1a5fb4;
    }

    .action-btn.share:hover {
        background: #1a73e8;
    }

    #downloadModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 100;
    }

    .modal-content {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 12px;
        width: 300px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .modal-content h3 {
        margin: 0 0 10px 0;
        color: #fff;
    }

    .size-inputs {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 10px;
    }

    .size-inputs input {
        flex: 1;
        padding: 8px;
        background: #222;
        border: 1px solid #444;
        border-radius: 6px;
        color: #fff;
        min-width: 120px;
        max-width: 160px;
        text-align: center;
        box-sizing: border-box;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .close-btn {
        position: absolute;
        top: 10px;
        right: 8px;
        background: #ff4444;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        color: white;
        font-weight: bold;
    }

    .service-tag {
        display: inline-block;
        background: #333;
        padding: 2px 12px;
        border-radius: 4px;
        font-size: 11px;
        color: #ccc;
        margin-top: 0px;
    }

    .context-menu {
        position: fixed;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 6px;
        padding: 8px 0;
        z-index: 1000;
        min-width: 150px;
        display: none;
    }

    .context-menu-item {
        padding: 8px 16px;
        cursor: pointer;
        color: #fff;
        font-size: 14px;
    }

    .context-menu-item:hover {
        background: #333;
    }

    .upload-notice {
        background: #333;
        padding: 10px;
        border-radius: 6px;
        margin: 10px 20px;
        text-align: center;
        font-size: 14px;
        color: #ccc;
        display: none;
    }

    .upload-notice.show {
        display: block;
    }

    .rate-btn {
        background: #444;
        border: none;
        border-radius: 4px;
        color: #ffd700;
        cursor: pointer;
        padding: 2px 6px;
        font-size: 11px;
        margin-left: 5px;
    }

    .rate-btn:hover {
        background: #555;
    }

    .rate-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 100;
    }

    .rate-modal-content {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 12px;
        width: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .star-rating-input {
        display: flex;
        gap: 5px;
        margin: 10px 0;
    }

    .star-rating-input span {
        font-size: 32px;
        color: #666;
        cursor: pointer;
        transition: color 0.2s;
    }

    .star-rating-input span:hover,
    .star-rating-input span:hover ~ span {
        color: #ffd700;
    }

    .star-rating-input span.selected {
        color: #ffd700;
    }

    .viewed-images {
        display: none;
    }
</style>
</head>

<body>
<header>
    <div class="header-left">
        <input id="search" placeholder="Search keywords..." />
        <div class="filters-container">
            <select id="sortFilter" class="filter">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="views_desc">Most Viewed</option>
                <option value="views_asc">Least Viewed</option>
                <option value="rating_desc">Highest Rated</option>
                <option value="rating_asc">Lowest Rated</option>
            </select>
        </div>
        <button id="uploadBtn">Upload Image</button>
    </div>
    <input type="file" id="fileInput" accept="image/*,video/mp4,video/webm,video/quicktime" style="display:none;" />
</header>

<div id="downloadModal">
    <div class="modal-content">
        <h3>Download Image</h3>
        <div class="size-inputs">
            <input type="number" id="widthInput" placeholder="Width (px)" min="1" />
            <input type="number" id="heightInput" placeholder="Height (px)" min="1" />
        </div>
        <div class="modal-actions">
            <button id="downloadOriginalBtn">Download Original</button>
            <button id="downloadCustomBtn">Download Custom Size</button>
            <button id="closeModalBtn">Cancel</button>
        </div>
    </div>
</div>

<div id="rateModal" class="rate-modal">
    <div class="rate-modal-content">
        <h3>Rate this Image</h3>
        <div class="star-rating-input" id="starRating">
            <span data-rating="1">‚òÜ</span>
            <span data-rating="2">‚òÜ</span>
            <span data-rating="3">‚òÜ</span>
            <span data-rating="4">‚òÜ</span>
            <span data-rating="5">‚òÜ</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="submitRatingBtn">Submit Rating</button>
            <button id="cancelRatingBtn">Cancel</button>
        </div>
    </div>
</div>

<div class="upload-notice" id="uploadNotice">
    Only verified users can upload GIFs/short videos. Contact admin for verification.
</div>

<div id="imageGrid"></div>

<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" id="shareRawItem">Share Raw Image</div>
    <div class="context-menu-item" id="copyLinkItem">Copy Direct Link</div>
    <div class="context-menu-item" id="downloadItem">Download</div>
</div>

<script>
const supabaseUrl = 'https://erctbeaqvqxjsrdjzonw.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyY3RiZWFxdnF4anNyZGp6b253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MzE2OTgsImV4cCI6MjA4MDIwNzY5OH0.Yal4o1NDY7p5W822mX7kaigTpPakTyygKLlp67ic6Kg';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

let allImages = [];
let currentUser = null;
let selectedImageForDownload = null;
let selectedImageForRating = null;
let currentSelectedRating = 0;
let lastFetchTime = 0;
const CACHE_DURATION = 30000;

const VIEWED_IMAGES_KEY = 'viewed_images';
const USER_ID_KEY = 'image_gallery_user_id';

function getUserId() {
    let userId = localStorage.getItem(USER_ID_KEY);
    if (!userId) {
        userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        localStorage.setItem(USER_ID_KEY, userId);
    }
    return userId;
}

function getViewedImages() {
    const viewed = sessionStorage.getItem(VIEWED_IMAGES_KEY);
    return viewed ? JSON.parse(viewed) : [];
}

function markImageAsViewed(imageId) {
    const viewed = getViewedImages();
    if (!viewed.includes(imageId)) {
        viewed.push(imageId);
        sessionStorage.setItem(VIEWED_IMAGES_KEY, JSON.stringify(viewed));
        return true;
    }
    return false;
}

async function initUser() {
    const userId = getUserId();
    currentUser = { id: userId };
}

async function loadImages() {
    const now = Date.now();
    
    if (allImages.length > 0 && (now - lastFetchTime) < CACHE_DURATION) {
        console.log('Using cached images');
        renderImages();
        return;
    }

    try {
        console.log('Fetching images...');
        const { data, error } = await supabase
            .from('profile_pictures')
            .select('*')
            .eq('verified', true)
            .order('created_at', { ascending: false });

        if (error) throw error;

        const imagesWithRatings = await Promise.all(data.map(async (item) => {
            const { data: ratings, error: ratingsError } = await supabase
                .from('user_ratings')
                .select('rating')
                .eq('image_id', item.id);

            let averageRating = 0;
            if (!ratingsError && ratings && ratings.length > 0) {
                const sum = ratings.reduce((total, r) => total + r.rating, 0);
                averageRating = sum / ratings.length;
            }

            return {
                id: item.id,
                src: item.url,
                service: item.service,
                keywords: item.keywords,
                rating: averageRating,
                views: item.views || 0,
                verified: item.verified || false,
                type: item.type || 'image',
                created_at: item.created_at,
                user_id: item.user_id
            };
        }));

        allImages = imagesWithRatings;
        lastFetchTime = Date.now();
        renderImages();

    } catch (error) {
        console.error('Error loading images:', error);
        renderImages();
    }
}

async function saveImage(imageData) {
    try {
        let imageSrc = imageData.src;
        
        // 1mb = compress
        if (imageSrc.length > 1000000) {
            console.log('Compressing large image...');
            imageSrc = await compressImage(imageSrc);
        }
        
        const { data, error } = await supabase
            .from('profile_pictures')
            .insert([
                {
                    url: imageSrc,
                    service: imageData.service,
                    keywords: imageData.keywords,
                    rating: 0,
                    views: 0,
                    verified: true,
                    type: imageData.type || 'image',
                    user_id: getUserId(),
                    created_at: new Date().toISOString()
                }
            ])
            .select()
            .single();

        if (error) {
            console.error('Supabase error:', error);
            throw error;
        }
        
        console.log('Image saved with ID:', data.id);
        return data.id;
        
    } catch (error) {
        console.error('Error saving image:', error);
        return null;
    }
}

function compressImage(dataUrl) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            const maxSize = 800;
            
            if (width > height && width > maxSize) {
                height = (height * maxSize) / width;
                width = maxSize;
            } else if (height > maxSize) {
                width = (width * maxSize) / height;
                height = maxSize;
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // jpeg and 0.8 quality
            const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
            resolve(compressedDataUrl);
        };
        img.src = dataUrl;
    });
}

async function incrementViews(imageId) {
    if (!markImageAsViewed(imageId)) {
        return;
    }
    
    try {
        const { data: image } = await supabase
            .from('profile_pictures')
            .select('views')
            .eq('id', imageId)
            .single();

        if (image) {
            const { error } = await supabase
                .from('profile_pictures')
                .update({ views: (image.views || 0) + 1 })
                .eq('id', imageId);

            if (!error) {
                // local cache
                const imgIndex = allImages.findIndex(img => img.id === imageId);
                if (imgIndex !== -1) {
                    allImages[imgIndex].views = (image.views || 0) + 1;
                }
            }
        }
    } catch (error) {
        console.error('Error incrementing views:', error);
    }
}

async function saveUserRating(imageId, rating) {
    const userId = getUserId();
    
    try {
        const { data: existingRating } = await supabase
            .from('user_ratings')
            .select('id')
            .eq('image_id', imageId)
            .eq('user_id', userId)
            .maybeSingle();

        if (existingRating) {
            const { error } = await supabase
                .from('user_ratings')
                .update({ 
                    rating: rating,
                    created_at: new Date().toISOString()
                })
                .eq('id', existingRating.id);

            if (error) throw error;
            console.log('Rating updated for image:', imageId);
        } else {
            const { error } = await supabase
                .from('user_ratings')
                .insert([
                    {
                        image_id: imageId,
                        user_id: userId,
                        rating: rating,
                        created_at: new Date().toISOString()
                    }
                ]);

            if (error) throw error;
            console.log('New rating saved for image:', imageId);
        }

        const { data: ratings } = await supabase
            .from('user_ratings')
            .select('rating')
            .eq('image_id', imageId);

        if (ratings && ratings.length > 0) {
            const sum = ratings.reduce((total, r) => total + r.rating, 0);
            const averageRating = sum / ratings.length;
            
            const imgIndex = allImages.findIndex(img => img.id === imageId);
            if (imgIndex !== -1) {
                allImages[imgIndex].rating = averageRating;
            }
        }
        
        return true;
        
    } catch (error) {
        console.error('Error saving rating:', error);
        return false;
    }
}

async function getUserRating(imageId) {
    const userId = getUserId();
    
    try {
        const { data, error } = await supabase
            .from('user_ratings')
            .select('rating')
            .eq('image_id', imageId)
            .eq('user_id', userId)
            .single();

        if (!error && data) {
            return data.rating;
        }
        return 0;
    } catch (error) {
        return 0;
    }
}

window.onload = async () => {
    await initUser();
    loadImages();
};

const searchBox = document.getElementById('search');
const sortFilter = document.getElementById('sortFilter');
let searchTimeout;

searchBox.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(renderImages, 300);
});

sortFilter.addEventListener('change', renderImages);

const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const uploadNotice = document.getElementById('uploadNotice');

uploadBtn.onclick = () => fileInput.click();

fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const isVideo = file.type.startsWith('video/');
    const isGif = file.type === 'image/gif';
    
    const userId = getUserId();
    let userCanUploadGifs = false;
    
    try {
        const { data: userData } = await supabase
            .from('verified_users')
            .select('can_upload_gifs')
            .eq('user_id', userId)
            .single();
        
        if (userData && userData.can_upload_gifs) {
            userCanUploadGifs = true;
        }
    } catch (error) {
        console.log('User not verified for GIF uploads');
    }
    
    if ((isVideo || isGif) && !userCanUploadGifs) {
        uploadNotice.classList.add('show');
        setTimeout(() => uploadNotice.classList.remove('show'), 3000);
        fileInput.value = '';
        return;
    }
    
    const maxSize = isVideo ? 10 * 1024 * 1024 : 2 * 1024 * 1024; // 10MB for videos, 2MB for images
    if (file.size > maxSize) {
        alert(`Max size: ${maxSize / 1024 / 1024}MB`);
        fileInput.value = '';
        return;
    }
    
    const keywords = prompt("Enter keywords for this image (comma separated):");
    if (!keywords || keywords.trim() === '') {
        alert('Keywords are required.');
        fileInput.value = '';
        return;
    }
    
    const service = prompt("Enter service/platform name (optional):") || 'General';
    
    const reader = new FileReader();
    reader.onload = async () => {
        const imageData = {
            src: reader.result,
            service: service,
            keywords: keywords.trim(),
            type: isVideo || isGif ? 'gif' : 'image'
        };

        const originalText = uploadBtn.textContent;
        uploadBtn.textContent = 'Uploading...';
        uploadBtn.disabled = true;

        try {
            const imageId = await saveImage(imageData);
            
            if (imageId) {
                alert("Image uploaded successfully!");
                loadImages();
            } else {
                alert("Upload failed. The image might be too large or there was a server error.");
            }
            
        } catch (error) {
            console.error('Upload error:', error);
            alert("Upload failed. Please try again with a smaller image.");
        } finally {
            uploadBtn.textContent = originalText;
            uploadBtn.disabled = false;
            fileInput.value = '';
        }
    };
    
    reader.onerror = () => {
        alert('Error reading file. Please try again.');
        uploadBtn.textContent = 'Upload Image';
        uploadBtn.disabled = false;
        fileInput.value = '';
    };
    
    reader.readAsDataURL(file);
};

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) {
        return 'Today';
    } else if (diffDays === 1) {
        return 'Yesterday';
    } else if (diffDays < 7) {
        return `${diffDays} days ago`;
    } else if (diffDays < 30) {
        const weeks = Math.floor(diffDays / 7);
        return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
    } else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
}

async function renderImages() {
    const grid = document.getElementById('imageGrid');
    const query = searchBox.value.toLowerCase();
    const sortBy = sortFilter.value;

    let filteredImages = allImages.filter(img => {
        if (!img) return false;
        
        const serviceMatch = img.service && img.service.toLowerCase().includes(query);
        const keywordMatch = img.keywords && img.keywords.toLowerCase().includes(query);
        return serviceMatch || keywordMatch;
    });

    filteredImages.sort((a, b) => {
        switch(sortBy) {
            case 'newest':
                return new Date(b.created_at) - new Date(a.created_at);
            case 'oldest':
                return new Date(a.created_at) - new Date(b.created_at);
            case 'views_desc':
                return (b.views || 0) - (a.views || 0);
            case 'views_asc':
                return (a.views || 0) - (b.views || 0);
            case 'rating_desc':
                return (b.rating || 0) - (a.rating || 0);
            case 'rating_asc':
                return (a.rating || 0) - (b.rating || 0);
            default:
                return 0;
        }
    });

    grid.innerHTML = '';

    if (filteredImages.length === 0) {
        const empty = document.createElement('div');
        empty.style.textAlign = 'center';
        empty.style.width = '100%';
        empty.style.padding = '60px';
        empty.style.color = '#666';
        empty.textContent = query ? 'No images found.' : 'No images yet.';
        grid.appendChild(empty);
        return;
    }

    for (const img of filteredImages) {
        const box = document.createElement('div');
        box.className = 'imgBox';

        const kwRow = document.createElement('div');
        kwRow.className = 'keywords-row';

        const kwLabel = document.createElement('span');
        kwLabel.className = 'keywords-label';
        kwLabel.textContent = 'Keywords:';

        const kwText = document.createElement('span');
        kwText.className = 'keywords-text';
        kwText.title = img.keywords || '';
        kwText.textContent = img.keywords || 'None';

        kwRow.appendChild(kwLabel);
        kwRow.appendChild(kwText);

        let mediaElement;
        if (img.type === 'gif' && (img.src.includes('data:video') || img.src.includes('.mp4') || img.src.includes('.webm'))) {
            mediaElement = document.createElement('video');
            mediaElement.src = img.src;
            mediaElement.controls = true;
            mediaElement.muted = true;
            mediaElement.autoplay = true;
            mediaElement.loop = true;
        } else {
            mediaElement = document.createElement('img');
            mediaElement.src = img.src;
            mediaElement.alt = img.keywords || 'Image';
            mediaElement.onerror = () => {
                mediaElement.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="240" height="200"><rect width="100%" height="100%" fill="%231a1a1a"/><text x="50%" y="50%" fill="%23666" font-size="14" text-anchor="middle" dy=".3em">Image</text></svg>';
            };
        }
        
        mediaElement.onclick = async () => {
            await incrementViews(img.id);
            renderImages();
        };
        
        mediaElement.oncontextmenu = (e) => {
            e.preventDefault();
            showContextMenu(e, img);
            return false;
        };

        const serviceTag = document.createElement('div');
        serviceTag.className = 'service-tag';
        serviceTag.textContent = img.service || 'General';

        const uploadDate = document.createElement('div');
        uploadDate.className = 'upload-date';
        uploadDate.textContent = formatDate(img.created_at);

        const bottom = document.createElement('div');
        bottom.className = 'bottom-row';

        const stats = document.createElement('div');
        stats.className = 'stats';
        stats.innerHTML = `
            <span>üëÅÔ∏è ${img.views || 0}</span>
        `;

        const ratingDiv = document.createElement('div');
        ratingDiv.className = 'rating';
        
        const avgRating = img.rating || 0;
        const roundedRating = Math.round(avgRating * 10) / 10;
        const fullStars = Math.floor(avgRating);
        const hasHalfStar = avgRating % 1 >= 0.5;
        
        ratingDiv.innerHTML = `
            <span class="rating-number">${roundedRating.toFixed(1)}</span>
            <span class="rating-stars">
                ${'‚òÖ'.repeat(fullStars)}${hasHalfStar ? '¬Ω' : ''}${'‚òÜ'.repeat(5 - fullStars - (hasHalfStar ? 1 : 0))}
            </span>
            <button class="rate-btn" data-image-id="${img.id}">Rate</button>
        `;

        bottom.appendChild(stats);
        bottom.appendChild(ratingDiv);

        const actionsRow = document.createElement('div');
        actionsRow.className = 'actions-row';

        const shareBtn = document.createElement('button');
        shareBtn.className = 'action-btn share';
        shareBtn.textContent = 'Share';
        shareBtn.onclick = () => shareImage(img);

        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'action-btn';
        downloadBtn.textContent = 'Download';
        downloadBtn.onclick = () => showDownloadModal(img);

        actionsRow.appendChild(shareBtn);
        actionsRow.appendChild(downloadBtn);

        box.appendChild(kwRow);
        box.appendChild(mediaElement);
        box.appendChild(serviceTag);
        box.appendChild(uploadDate);
        box.appendChild(bottom);
        box.appendChild(actionsRow);

        grid.appendChild(box);
    }

    document.querySelectorAll('.rate-btn').forEach(btn => {
        btn.onclick = async (e) => {
            e.stopPropagation();
            const imageId = parseInt(e.target.dataset.imageId);
            selectedImageForRating = imageId;
            
            const existingRating = await getUserRating(imageId);
            currentSelectedRating = existingRating;
            
            showRateModal(existingRating);
        };
    });
}

const rateModal = document.getElementById('rateModal');
const starRating = document.getElementById('starRating');
const submitRatingBtn = document.getElementById('submitRatingBtn');
const cancelRatingBtn = document.getElementById('cancelRatingBtn');

starRating.addEventListener('click', (e) => {
    if (e.target.tagName === 'SPAN' && e.target.dataset.rating) {
        const rating = parseInt(e.target.dataset.rating);
        currentSelectedRating = rating;
        
        const stars = starRating.querySelectorAll('span');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.textContent = '‚òÖ';
                star.classList.add('selected');
            } else {
                star.textContent = '‚òÜ';
                star.classList.remove('selected');
            }
        });
    }
});

starRating.addEventListener('mouseover', (e) => {
    if (e.target.tagName === 'SPAN' && e.target.dataset.rating) {
        const hoverRating = parseInt(e.target.dataset.rating);
        const stars = starRating.querySelectorAll('span');
        stars.forEach((star, index) => {
            if (index < hoverRating) {
                star.textContent = '‚òÖ';
            } else {
                star.textContent = '‚òÜ';
            }
        });
    }
});

starRating.addEventListener('mouseleave', () => {
    const stars = starRating.querySelectorAll('span');
    stars.forEach((star, index) => {
        if (index < currentSelectedRating) {
            star.textContent = '‚òÖ';
            star.classList.add('selected');
        } else {
            star.textContent = '‚òÜ';
            star.classList.remove('selected');
        }
    });
});

function showRateModal(existingRating = 0) {
    currentSelectedRating = existingRating;
    
    const stars = starRating.querySelectorAll('span');
    stars.forEach((star, index) => {
        if (index < existingRating) {
            star.textContent = '‚òÖ';
            star.classList.add('selected');
        } else {
            star.textContent = '‚òÜ';
            star.classList.remove('selected');
        }
    });
    
    rateModal.style.display = 'flex';
}

function hideRateModal() {
    rateModal.style.display = 'none';
    selectedImageForRating = null;
    currentSelectedRating = 0;
}

submitRatingBtn.onclick = async () => {
    if (selectedImageForRating && currentSelectedRating > 0) {
        const success = await saveUserRating(selectedImageForRating, currentSelectedRating);
        if (success) {
            alert('Rating submitted!');
            hideRateModal();
            renderImages();
        } else {
            alert('Failed to submit rating. Please try again.');
        }
    }
};

cancelRatingBtn.onclick = hideRateModal;

const contextMenu = document.getElementById('contextMenu');
const shareRawItem = document.getElementById('shareRawItem');
const copyLinkItem = document.getElementById('copyLinkItem');
const downloadItem = document.getElementById('downloadItem');

let currentContextImage = null;

function showContextMenu(e, image) {
    currentContextImage = image;
    contextMenu.style.display = 'block';
    contextMenu.style.left = e.pageX + 'px';
    contextMenu.style.top = e.pageY + 'px';
    
    document.addEventListener('click', hideContextMenu);
}

function hideContextMenu() {
    contextMenu.style.display = 'none';
    document.removeEventListener('click', hideContextMenu);
}

shareRawItem.onclick = () => {
    if (currentContextImage) {
        shareImage(currentContextImage, true);
    }
    hideContextMenu();
};

copyLinkItem.onclick = async () => {
    if (currentContextImage) {
        try {
            await navigator.clipboard.writeText(currentContextImage.src);
            alert('Direct link copied to clipboard!');
        } catch (err) {
            console.error('Failed to copy:', err);

            const textArea = document.createElement('textarea');
            textArea.value = currentContextImage.src;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Link copied!');
        }
    }
    hideContextMenu();
};

downloadItem.onclick = () => {
    if (currentContextImage) {
        showDownloadModal(currentContextImage);
    }
    hideContextMenu();
};

function shareImage(image, raw = false) {
    const shareUrl = raw ? image.src : window.location.origin + window.location.pathname + '?image=' + image.id;
    
    if (navigator.share) {
        navigator.share({
            title: image.keywords || 'Image',
            text: `Check out this image${image.service ? ' from ' + image.service : ''}: ${image.keywords || ''}`,
            url: shareUrl,
        })
        .then(() => console.log('Shared successfully'))
        .catch(err => {
            console.log('Share failed:', err);
            copyToClipboard(shareUrl);
        });
    } else {
        copyToClipboard(shareUrl);
    }
}

function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
            .then(() => alert('Link copied to clipboard!'))
            .catch(() => fallbackCopy(text));
    } else {
        fallbackCopy(text);
    }
}

function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        if (successful) {
            alert('Link copied to clipboard!');
        } else {
            alert('Failed to copy link. Please copy manually: ' + text);
        }
    } catch (err) {
        document.body.removeChild(textArea);
        alert('Failed to copy link. Please copy manually: ' + text);
    }
}

const downloadModal = document.getElementById('downloadModal');
const widthInput = document.getElementById('widthInput');
const heightInput = document.getElementById('heightInput');
const downloadOriginalBtn = document.getElementById('downloadOriginalBtn');
const downloadCustomBtn = document.getElementById('downloadCustomBtn');
const closeModalBtn = document.getElementById('closeModalBtn');

function showDownloadModal(image) {
    selectedImageForDownload = image;
    widthInput.value = '';
    heightInput.value = '';
    downloadModal.style.display = 'flex';
}

function hideDownloadModal() {
    downloadModal.style.display = 'none';
    selectedImageForDownload = null;
}

closeModalBtn.onclick = hideDownloadModal;

downloadOriginalBtn.onclick = () => {
    if (selectedImageForDownload) {
        downloadImage(selectedImageForDownload.src, selectedImageForDownload.keywords || 'image');
        hideDownloadModal();
    }
};

downloadCustomBtn.onclick = () => {
    if (!selectedImageForDownload) return;
    
    const width = parseInt(widthInput.value);
    const height = parseInt(heightInput.value);
    
    if (width && height && width > 0 && height > 0) {
        downloadImageAtSize(selectedImageForDownload.src, width, height, selectedImageForDownload.keywords || 'image');
    } else {
        downloadImage(selectedImageForDownload.src, selectedImageForDownload.keywords || 'image');
    }
    hideDownloadModal();
};

function downloadImage(src, name) {
    const a = document.createElement('a');
    a.href = src;
    const extension = src.includes('data:video') ? 'mp4' : 'png';
    const filename = name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
    a.download = `${filename}_${Date.now()}.${extension}`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function downloadImageAtSize(src, width, height, name) {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        const filename = name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        a.download = `${filename}_${width}x${height}_${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    };
    img.onerror = function() {
        downloadImage(src, name);
    };
    img.src = src;
}

downloadModal.onclick = (e) => {
    if (e.target === downloadModal) {
        hideDownloadModal();
    }
};

rateModal.onclick = (e) => {
    if (e.target === rateModal) {
        hideRateModal();
    }
};

setInterval(() => {
    if (document.visibilityState === 'visible') {
        loadImages();
    }
}, 120000);
</script>
</body>
</html>
