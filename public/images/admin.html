<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Panel - Image Management</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        background: #0f0f0f;
        color: white;
        min-height: 100vh;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Login Page */
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }

    .login-box {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        padding: 40px;
        border-radius: 20px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .login-box h1 {
        text-align: center;
        margin-bottom: 30px;
        color: white;
        font-size: 28px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
    }

    .form-group input {
        width: 100%;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        color: white;
        font-size: 16px;
        transition: all 0.3s;
    }

    .form-group input:focus {
        outline: none;
        border-color: #667eea;
        background: rgba(255, 255, 255, 0.15);
    }

    .login-btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .error-message {
        color: #ff4444;
        text-align: center;
        margin-top: 15px;
        font-size: 14px;
    }

    /* Admin Dashboard */
    .dashboard {
        display: none;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        margin-bottom: 30px;
        border-bottom: 1px solid #333;
    }

    .header h1 {
        font-size: 28px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .logout-btn {
        padding: 10px 24px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.3s;
    }

    .logout-btn:hover {
        background: #ff3333;
    }

    /* Tabs */
    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
        flex-wrap: wrap;
    }

    .tab {
        padding: 12px 24px;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        color: #888;
        font-weight: 500;
        transition: all 0.3s;
    }

    .tab:hover {
        background: #222;
        color: white;
    }

    .tab.active {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border-color: #667eea;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Stats */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: #1a1a1a;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #333;
        transition: transform 0.3s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        border-color: #667eea;
    }

    .stat-card h3 {
        font-size: 14px;
        color: #888;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .stat-card .number {
        font-size: 36px;
        font-weight: bold;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .stat-card .subtext {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }

    /* Data Tables */
    .data-table {
        width: 100%;
        background: #1a1a1a;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #333;
        margin-top: 20px;
    }

    .data-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        background: #222;
        padding: 15px;
        text-align: left;
        color: #888;
        font-weight: 600;
        border-bottom: 1px solid #333;
    }

    .data-table td {
        padding: 15px;
        border-bottom: 1px solid #333;
        color: #ccc;
    }

    .data-table tr:hover {
        background: #222;
    }

    .table-actions {
        display: flex;
        gap: 8px;
    }

    .table-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.3s;
    }

    .delete-btn {
        background: #ff4444;
        color: white;
    }

    .delete-btn:hover {
        background: #ff3333;
    }

    .edit-btn {
        background: #2196F3;
        color: white;
    }

    .edit-btn:hover {
        background: #1976D2;
    }

    /* Charts */
    .chart-container {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #333;
        margin-bottom: 20px;
    }

    .chart-container h3 {
        margin-bottom: 20px;
        color: #fff;
    }

    .chart-placeholder {
        height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
    }

    /* Search and Filters */
    .controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: center;
        flex-wrap: wrap;
        background: #1a1a1a;
        padding: 15px;
        border-radius: 12px;
        border: 1px solid #333;
    }

    .search-box {
        flex: 1;
        min-width: 200px;
        padding: 10px 15px;
        background: #222;
        border: 1px solid #333;
        border-radius: 8px;
        color: white;
    }

    .filter-select {
        padding: 10px 15px;
        background: #222;
        border: 1px solid #333;
        border-radius: 8px;
        color: white;
        min-width: 150px;
    }

    .date-range {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .date-input {
        padding: 10px;
        background: #222;
        border: 1px solid #333;
        border-radius: 8px;
        color: white;
        min-width: 140px;
    }

    /* Export Controls */
    .export-controls {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .export-btn {
        padding: 10px 20px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.3s;
    }

    .export-btn:hover {
        background: #45a049;
    }

    /* Loading */
    .loading {
        text-align: center;
        padding: 60px;
        color: #666;
    }

    .loading-spinner {
        border: 4px solid #333;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Modal */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: #1a1a1a;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        border: 1px solid #333;
    }

    .modal h3 {
        margin-bottom: 20px;
        color: white;
    }

    .modal p {
        margin-bottom: 20px;
        color: #ccc;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    .confirm-btn {
        padding: 10px 20px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    .cancel-btn {
        padding: 10px 20px;
        background: #333;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    /* Edit Modal */
    .edit-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .edit-form label {
        color: #ccc;
        font-size: 14px;
    }

    .edit-form input,
    .edit-form textarea,
    .edit-form select {
        padding: 10px;
        background: #222;
        border: 1px solid #333;
        border-radius: 6px;
        color: white;
    }

    .edit-form textarea {
        min-height: 100px;
        resize: vertical;
    }

    /* System Info */
    .system-info {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #333;
        margin-top: 20px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .info-item {
        padding: 10px;
        background: #222;
        border-radius: 8px;
        border: 1px solid #333;
    }

    .info-label {
        font-size: 12px;
        color: #888;
        margin-bottom: 5px;
    }

    .info-value {
        color: #ccc;
        font-weight: 500;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .container {
            padding: 10px;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .tabs {
            gap: 5px;
        }
        
        .tab {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .controls {
            flex-direction: column;
        }
        
        .data-table {
            overflow-x: auto;
        }
        
        .data-table table {
            min-width: 800px;
        }
    }
</style>
</head>

<body>
<!-- Login Page -->
<div id="loginPage" class="login-container">
    <div class="login-box">
        <h1>Admin Panel</h1>
        <div class="form-group">
            <label>Username</label>
            <input type="text" id="username" placeholder="Enter admin username" autocomplete="off">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="password" placeholder="Enter admin password">
        </div>
        <button class="login-btn" onclick="login()">Login</button>
        <div id="loginError" class="error-message"></div>
    </div>
</div>

<!-- Admin Dashboard -->
<div id="dashboard" class="dashboard container">
    <div class="header">
        <h1>Image Gallery Admin</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('dashboard-tab')">üìä Dashboard</div>
        <div class="tab" onclick="switchTab('images-tab')">üñºÔ∏è Images</div>
        <div class="tab" onclick="switchTab('users-tab')">üë• Users</div>
        <div class="tab" onclick="switchTab('analytics-tab')">üìà Analytics</div>
        <div class="tab" onclick="switchTab('system-tab')">‚öôÔ∏è System</div>
        <div class="tab" onclick="switchTab('logs-tab')">üìã Logs</div>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Images</h3>
                <div class="number" id="totalImages">0</div>
                <div class="subtext" id="imagesBreakdown"></div>
            </div>
            <div class="stat-card">
                <h3>Total Views</h3>
                <div class="number" id="totalViews">0</div>
                <div class="subtext">Today: <span id="todayViews">0</span></div>
            </div>
            <div class="stat-card">
                <h3>Active Users</h3>
                <div class="number" id="activeUsers">0</div>
                <div class="subtext">Last 24h: <span id="recentUsers">0</span></div>
            </div>
            <div class="stat-card">
                <h3>Storage Used</h3>
                <div class="number" id="storageUsed">0 MB</div>
                <div class="subtext">Average per image: <span id="avgImageSize">0 KB</span></div>
            </div>
            <div class="stat-card">
                <h3>Avg Rating</h3>
                <div class="number" id="avgRating">0.0</div>
                <div class="subtext">Total ratings: <span id="totalRatings">0</span></div>
            </div>
            <div class="stat-card">
                <h3>Uploads Today</h3>
                <div class="number" id="uploadsToday">0</div>
                <div class="subtext">This week: <span id="uploadsWeek">0</span></div>
            </div>
        </div>

        <div class="chart-container">
            <h3>Upload Activity (Last 7 Days)</h3>
            <canvas id="uploadsChart"></canvas>
        </div>

        <div class="controls">
            <button class="export-btn" onclick="exportDashboardData()">Export Dashboard Data</button>
            <button class="export-btn" onclick="refreshDashboard()" style="background: #2196F3;">Refresh</button>
        </div>
    </div>

    <!-- Images Tab -->
    <div id="images-tab" class="tab-content">
        <div class="controls">
            <input type="text" id="imageSearch" class="search-box" placeholder="Search images..." onkeyup="filterImages()">
            <select id="imageSort" class="filter-select" onchange="filterImages()">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="most_views">Most Views</option>
                <option value="least_views">Least Views</option>
                <option value="highest_rated">Highest Rated</option>
                <option value="lowest_rated">Lowest Rated</option>
            </select>
            <select id="imageType" class="filter-select" onchange="filterImages()">
                <option value="all">All Types</option>
                <option value="image">Images</option>
                <option value="gif">GIFs/Videos</option>
            </select>
            <div class="date-range">
                <input type="date" id="startDate" class="date-input" onchange="filterImages()">
                <span>to</span>
                <input type="date" id="endDate" class="date-input" onchange="filterImages()">
            </div>
            <button class="export-btn" onclick="exportImagesData()">Export CSV</button>
        </div>

        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Preview</th>
                        <th>Keywords</th>
                        <th>Service</th>
                        <th>Type</th>
                        <th>Views</th>
                        <th>Rating</th>
                        <th>Uploaded</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="imagesTableBody">
                    <tr>
                        <td colspan="9" class="loading">
                            <div class="loading-spinner"></div>
                            Loading images...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="export-controls">
            <button class="export-btn" onclick="deleteSelectedImages()" style="background: #ff4444;">Delete Selected</button>
            <button class="export-btn" onclick="selectAllImages()">Select All</button>
            <button class="export-btn" onclick="deselectAllImages()">Deselect All</button>
        </div>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
        <div class="controls">
            <input type="text" id="userSearch" class="search-box" placeholder="Search users..." onkeyup="filterUsers()">
            <select id="userFilter" class="filter-select" onchange="filterUsers()">
                <option value="all">All Users</option>
                <option value="verified">Verified Only</option>
                <option value="unverified">Unverified Only</option>
                <option value="gif_access">Has GIF Access</option>
                <option value="uploaders">Active Uploaders</option>
            </select>
            <button class="export-btn" onclick="exportUsersData()">Export CSV</button>
            <button class="export-btn" onclick="addNewUser()" style="background: #4CAF50;">Add New User</button>
        </div>

        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Uploads</th>
                        <th>Total Views</th>
                        <th>GIF Access</th>
                        <th>Last Active</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="9" class="loading">
                            <div class="loading-spinner"></div>
                            Loading users...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics-tab" class="tab-content">
        <div class="chart-container">
            <h3>Uploads Over Time</h3>
            <canvas id="uploadsOverTimeChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>Image Type Distribution</h3>
            <canvas id="typeDistributionChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>Top Services</h3>
            <canvas id="topServicesChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>Daily Views</h3>
            <canvas id="dailyViewsChart"></canvas>
        </div>

        <div class="export-controls">
            <button class="export-btn" onclick="exportAnalyticsData()">Export Analytics</button>
            <button class="export-btn" onclick="generateReport()" style="background: #9C27B0;">Generate Report</button>
        </div>
    </div>

    <!-- System Tab -->
    <div id="system-tab" class="tab-content">
        <div class="system-info">
            <h3>Database Information</h3>
            <div class="info-grid" id="dbInfo">
                <div class="info-item">
                    <div class="info-label">Total Tables</div>
                    <div class="info-value" id="totalTables">Loading...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Database Size</div>
                    <div class="info-value" id="dbSize">Loading...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Last Backup</div>
                    <div class="info-value" id="lastBackup">Never</div>
                </div>
            </div>
        </div>

        <div class="system-info">
            <h3>Server Status</h3>
            <div class="info-grid" id="serverInfo">
                <div class="info-item">
                    <div class="info-label">API Status</div>
                    <div class="info-value" id="apiStatus">Checking...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Response Time</div>
                    <div class="info-value" id="responseTime">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Uptime</div>
                    <div class="info-value" id="uptime">-</div>
                </div>
            </div>
        </div>

        <div class="system-info">
            <h3>System Actions</h3>
            <div class="export-controls">
                <button class="export-btn" onclick="clearCache()" style="background: #FF9800;">Clear Cache</button>
                <button class="export-btn" onclick="optimizeDatabase()" style="background: #2196F3;">Optimize DB</button>
                <button class="export-btn" onclick="backupDatabase()" style="background: #4CAF50;">Backup Now</button>
                <button class="export-btn" onclick="showSystemLogs()" style="background: #795548;">View Logs</button>
            </div>
        </div>
    </div>

    <!-- Logs Tab -->
    <div id="logs-tab" class="tab-content">
        <div class="controls">
            <select id="logLevel" class="filter-select" onchange="filterLogs()">
                <option value="all">All Levels</option>
                <option value="info">Info</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
            </select>
            <select id="logType" class="filter-select" onchange="filterLogs()">
                <option value="all">All Types</option>
                <option value="upload">Uploads</option>
                <option value="user">Users</option>
                <option value="system">System</option>
            </select>
            <input type="date" id="logDate" class="date-input" onchange="filterLogs()">
            <button class="export-btn" onclick="exportLogs()">Export Logs</button>
            <button class="export-btn" onclick="clearOldLogs()" style="background: #ff4444;">Clear Old Logs</button>
        </div>

        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Level</th>
                        <th>Type</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                    <tr>
                        <td colspan="6" class="loading">
                            <div class="loading-spinner"></div>
                            Loading logs...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3>Confirm Delete</h3>
        <p id="deleteModalText">Are you sure you want to delete this item?</p>
        <div class="modal-actions">
            <button class="cancel-btn" onclick="hideModal()">Cancel</button>
            <button class="confirm-btn" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>

<!-- Edit Image Modal -->
<div id="editImageModal" class="modal">
    <div class="modal-content">
        <h3>Edit Image</h3>
        <div class="edit-form">
            <label>Keywords</label>
            <textarea id="editKeywords" placeholder="Enter keywords"></textarea>
            
            <label>Service</label>
            <input type="text" id="editService" placeholder="Service name">
            
            <label>Type</label>
            <select id="editType">
                <option value="image">Image</option>
                <option value="gif">GIF/Video</option>
            </select>
            
            <label>Views</label>
            <input type="number" id="editViews" min="0">
            
            <label>Rating</label>
            <input type="number" id="editRating" min="0" max="5" step="0.1">
        </div>
        <div class="modal-actions">
            <button class="cancel-btn" onclick="hideModal()">Cancel</button>
            <button class="confirm-btn" onclick="saveImageEdit()" style="background: #4CAF50;">Save</button>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="modal">
    <div class="modal-content">
        <h3>Add New User</h3>
        <div class="edit-form">
            <label>User ID (Optional)</label>
            <input type="text" id="newUserId" placeholder="Leave empty for auto-generated">
            
            <label>Username</label>
            <input type="text" id="newUsername" placeholder="Username" required>
            
            <label>Email</label>
            <input type="email" id="newUserEmail" placeholder="Email address" required>
            
            <label>GIF Upload Access</label>
            <select id="newUserGifAccess">
                <option value="true">Allow GIF Uploads</option>
                <option value="false">No GIF Uploads</option>
            </select>
            
            <label>Verification Status</label>
            <select id="newUserVerified">
                <option value="true">Verified</option>
                <option value="false">Not Verified</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="cancel-btn" onclick="hideModal()">Cancel</button>
            <button class="confirm-btn" onclick="saveNewUser()" style="background: #4CAF50;">Add User</button>
        </div>
    </div>
</div>

<script>
// Supabase setup
const supabaseUrl = 'https://erctbeaqvqxjsrdjzonw.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyY3RiZWFxdnF4anNyZGp6b253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MzE2OTgsImV4cCI6MjA4MDIwNzY5OH0.Yal4o1NDY7p5W822mX7kaigTpPakTyygKLlp67ic6Kg';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

let adminLoggedIn = false;
let allImages = [];
let allUsers = [];
let allLogs = [];
let charts = {};
let currentModal = null;
let currentEditImageId = null;
let selectedImages = new Set();

// Admin credentials (CHANGE THIS IN PRODUCTION!)
const ADMIN_CREDENTIALS = {
    username: 'admin',
    password: 'admin123' 
};

// Initialize
window.onload = () => {
    const token = localStorage.getItem('adminToken');
    if (token && token === 'admin_logged_in') {
        adminLoggedIn = true;
        showDashboard();
        loadDashboardData();
    }
};

// Login function
async function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('loginError');

    errorDiv.textContent = '';

    if (!username || !password) {
        errorDiv.textContent = 'Please enter both username and password';
        return;
    }

    // Simple authentication (replace with proper auth in production)
    if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
        localStorage.setItem('adminToken', 'admin_logged_in');
        adminLoggedIn = true;
        showDashboard();
        loadDashboardData();
        logAction('system', 'Admin login successful');
    } else {
        errorDiv.textContent = 'Invalid credentials';
        logAction('system', 'Failed admin login attempt');
    }
}

function showDashboard() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
}

function logout() {
    localStorage.removeItem('adminToken');
    adminLoggedIn = false;
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    logAction('system', 'Admin logout');
}

function switchTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
    
    // Load tab data
    switch(tabId) {
        case 'dashboard-tab':
            loadDashboardData();
            break;
        case 'images-tab':
            loadImagesData();
            break;
        case 'users-tab':
            loadUsersData();
            break;
        case 'analytics-tab':
            loadAnalyticsData();
            break;
        case 'system-tab':
            loadSystemInfo();
            break;
        case 'logs-tab':
            loadLogsData();
            break;
    }
}

// Dashboard Functions
async function loadDashboardData() {
    if (!adminLoggedIn) return;
    
    try {
        // Get total images count
        const { count: totalImages } = await supabase
            .from('profile_pictures')
            .select('*', { count: 'exact', head: true });
        
        // Get images breakdown by type
        const { data: imagesByType } = await supabase
            .from('profile_pictures')
            .select('type');
        
        let imagesCount = { image: 0, gif: 0 };
        imagesByType?.forEach(img => {
            if (img.type === 'gif') imagesCount.gif++;
            else imagesCount.image++;
        });
        
        // Get total views
        const { data: viewsData } = await supabase
            .from('profile_pictures')
            .select('views');
        const totalViews = viewsData?.reduce((sum, img) => sum + (img.views || 0), 0) || 0;
        
        // Get today's views (images created today)
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const { data: todayViewsData } = await supabase
            .from('profile_pictures')
            .select('views')
            .gte('created_at', today.toISOString());
        const todayViews = todayViewsData?.reduce((sum, img) => sum + (img.views || 0), 0) || 0;
        
        // Get average rating
        const { data: ratingsData } = await supabase
            .from('user_ratings')
            .select('rating');
        const totalRatings = ratingsData?.length || 0;
        const avgRating = totalRatings > 0 ? 
            (ratingsData.reduce((sum, r) => sum + r.rating, 0) / totalRatings).toFixed(1) : '0.0';
        
        // Get uploads today
        const { count: uploadsToday } = await supabase
            .from('profile_pictures')
            .select('*', { count: 'exact', head: true })
            .gte('created_at', today.toISOString());
        
        // Get uploads this week
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        const { count: uploadsWeek } = await supabase
            .from('profile_pictures')
            .select('*', { count: 'exact', head: true })
            .gte('created_at', weekAgo.toISOString());
        
        // Get unique users (from user_ratings and profile_pictures)
        const { data: uniqueRaters } = await supabase
            .from('user_ratings')
            .select('user_id');
        const { data: uniqueUploaders } = await supabase
            .from('profile_pictures')
            .select('user_id');
        
        const userSet = new Set();
        uniqueRaters?.forEach(r => userSet.add(r.user_id));
        uniqueUploaders?.forEach(u => userSet.add(u.user_id));
        const activeUsers = userSet.size;
        
        // Get recent users (last 24 hours)
        const dayAgo = new Date();
        dayAgo.setDate(dayAgo.getDate() - 1);
        const { data: recentRatings } = await supabase
            .from('user_ratings')
            .select('user_id')
            .gte('created_at', dayAgo.toISOString());
        const recentUsers = new Set(recentRatings?.map(r => r.user_id)).size;
        
        // Calculate storage (rough estimate - 0.5MB per image)
        const estimatedStorage = totalImages ? (totalImages * 0.5).toFixed(1) : '0';
        const avgImageSize = totalImages ? ((totalImages * 0.5 * 1024) / totalImages).toFixed(0) : '0';
        
        // Update UI
        document.getElementById('totalImages').textContent = totalImages || 0;
        document.getElementById('imagesBreakdown').textContent = 
            `${imagesCount.image} images, ${imagesCount.gif} GIFs`;
        document.getElementById('totalViews').textContent = totalViews.toLocaleString();
        document.getElementById('todayViews').textContent = todayViews.toLocaleString();
        document.getElementById('avgRating').textContent = avgRating;
        document.getElementById('totalRatings').textContent = totalRatings.toLocaleString();
        document.getElementById('uploadsToday').textContent = uploadsToday || 0;
        document.getElementById('uploadsWeek').textContent = uploadsWeek || 0;
        document.getElementById('activeUsers').textContent = activeUsers;
        document.getElementById('recentUsers').textContent = recentUsers;
        document.getElementById('storageUsed').textContent = `${estimatedStorage} MB`;
        document.getElementById('avgImageSize').textContent = `${avgImageSize} KB`;
        
        // Create uploads chart
        createUploadsChart();
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

function createUploadsChart() {
    const ctx = document.getElementById('uploadsChart').getContext('2d');
    
    if (charts.uploadsChart) {
        charts.uploadsChart.destroy();
    }
    
    // Sample data - in production, fetch actual data
    const labels = [];
    const data = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
        data.push(Math.floor(Math.random() * 20) + 5); // Random data for demo
    }
    
    charts.uploadsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Uploads',
                data: data,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#888'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#888'
                    }
                }
            }
        }
    });
}

// Images Management
async function loadImagesData() {
    if (!adminLoggedIn) return;
    
    try {
        const { data, error } = await supabase
            .from('profile_pictures')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) throw error;

        allImages = data || [];
        displayImagesTable(allImages);
        
    } catch (error) {
        console.error('Error loading images:', error);
        document.getElementById('imagesTableBody').innerHTML = 
            '<tr><td colspan="9" style="color: #ff4444; text-align: center;">Error loading images</td></tr>';
    }
}

function displayImagesTable(images) {
    const tbody = document.getElementById('imagesTableBody');
    
    if (!images || images.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">No images found</td></tr>';
        return;
    }

    tbody.innerHTML = images.map(image => `
        <tr>
            <td style="font-family: monospace; font-size: 12px;">${image.id}</td>
            <td>
                <img src="${image.url}" alt="preview" 
                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;"
                     onerror="this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"50\" height=\"50\"><rect width=\"100%\" height=\"100%\" fill=\"%23222\"/><text x=\"50%\" y=\"50%\" fill=\"%23666\" font-size=\"10\" text-anchor=\"middle\" dy=\".3em\">IMG</text></svg>'">
            </td>
            <td>${(image.keywords || '').substring(0, 30)}${(image.keywords || '').length > 30 ? '...' : ''}</td>
            <td>${image.service || 'General'}</td>
            <td>
                <span style="padding: 2px 8px; background: ${image.type === 'gif' ? '#2196F3' : '#4CAF50'}; border-radius: 12px; font-size: 11px;">
                    ${image.type || 'image'}
                </span>
            </td>
            <td>${(image.views || 0).toLocaleString()}</td>
            <td>${(image.rating || 0).toFixed(1)}</td>
            <td>${new Date(image.created_at).toLocaleDateString()}</td>
            <td>
                <div class="table-actions">
                    <button class="table-btn edit-btn" onclick="editImage(${image.id})">Edit</button>
                    <button class="table-btn delete-btn" onclick="showDeleteModal('image', ${image.id})">Delete</button>
                    <input type="checkbox" onchange="toggleImageSelection(${image.id}, this.checked)" style="margin-left: 5px;">
                </div>
            </td>
        </tr>
    `).join('');
}

function filterImages() {
    const searchTerm = document.getElementById('imageSearch').value.toLowerCase();
    const sortBy = document.getElementById('imageSort').value;
    const typeFilter = document.getElementById('imageType').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    let filtered = allImages.filter(img => {
        if (!img) return false;
        
        // Type filter
        if (typeFilter !== 'all' && img.type !== typeFilter) return false;
        
        // Date filter
        if (startDate) {
            const imgDate = new Date(img.created_at);
            const filterDate = new Date(startDate);
            if (imgDate < filterDate) return false;
        }
        
        if (endDate) {
            const imgDate = new Date(img.created_at);
            const filterDate = new Date(endDate);
            filterDate.setHours(23, 59, 59, 999);
            if (imgDate > filterDate) return false;
        }
        
        // Search filter
        const searchMatch = 
            (img.service && img.service.toLowerCase().includes(searchTerm)) ||
            (img.keywords && img.keywords.toLowerCase().includes(searchTerm)) ||
            (img.user_id && img.user_id.includes(searchTerm));
        
        return searchMatch;
    });

    // Apply sorting
    filtered.sort((a, b) => {
        switch(sortBy) {
            case 'newest':
                return new Date(b.created_at) - new Date(a.created_at);
            case 'oldest':
                return new Date(a.created_at) - new Date(b.created_at);
            case 'most_views':
                return (b.views || 0) - (a.views || 0);
            case 'least_views':
                return (a.views || 0) - (b.views || 0);
            case 'highest_rated':
                return (b.rating || 0) - (a.rating || 0);
            case 'lowest_rated':
                return (a.rating || 0) - (b.rating || 0);
            default:
                return 0;
        }
    });

    displayImagesTable(filtered);
}

// Users Management
async function loadUsersData() {
    if (!adminLoggedIn) return;
    
    try {
        // Get verified users
        const { data: verifiedUsers, error: usersError } = await supabase
            .from('verified_users')
            .select('*');

        if (usersError) throw usersError;

        // Get user activity from images
        const { data: userImages } = await supabase
            .from('profile_pictures')
            .select('user_id, views');

        // Create user map with stats
        const userMap = new Map();
        
        // Add verified users
        verifiedUsers?.forEach(user => {
            userMap.set(user.user_id, {
                id: user.user_id,
                email: user.email,
                username: user.username,
                verified: true,
                can_upload_gifs: user.can_upload_gifs,
                uploads: 0,
                total_views: 0,
                last_active: user.verified_at
            });
        });

        // Count user uploads and views
        userImages?.forEach(image => {
            if (image.user_id) {
                if (!userMap.has(image.user_id)) {
                    userMap.set(image.user_id, {
                        id: image.user_id,
                        email: 'Anonymous',
                        username: `User_${image.user_id.substring(0, 8)}`,
                        verified: false,
                        can_upload_gifs: false,
                        uploads: 0,
                        total_views: 0,
                        last_active: null
                    });
                }
                const user = userMap.get(image.user_id);
                user.uploads++;
                user.total_views += (image.views || 0);
            }
        });

        // Get ratings to update last_active
        const { data: userRatings } = await supabase
            .from('user_ratings')
            .select('user_id, created_at')
            .order('created_at', { ascending: false });

        userRatings?.forEach(rating => {
            if (userMap.has(rating.user_id)) {
                const user = userMap.get(rating.user_id);
                if (!user.last_active || new Date(rating.created_at) > new Date(user.last_active)) {
                    user.last_active = rating.created_at;
                }
            }
        });

        allUsers = Array.from(userMap.values());
        displayUsersTable(allUsers);
        
    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTableBody').innerHTML = 
            '<tr><td colspan="9" style="color: #ff4444; text-align: center;">Error loading users</td></tr>';
    }
}

function displayUsersTable(users) {
    const tbody = document.getElementById('usersTableBody');
    
    if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">No users found</td></tr>';
        return;
    }

    tbody.innerHTML = users.map(user => `
        <tr>
            <td style="font-family: monospace; font-size: 12px;">${user.id.substring(0, 12)}...</td>
            <td>${user.username}</td>
            <td>${user.email}</td>
            <td>
                <span style="padding: 2px 8px; background: ${user.verified ? '#4CAF50' : '#FF9800'}; border-radius: 12px; font-size: 11px;">
                    ${user.verified ? 'Verified' : 'Unverified'}
                </span>
            </td>
            <td>${user.uploads || 0}</td>
            <td>${(user.total_views || 0).toLocaleString()}</td>
            <td>
                <span style="padding: 2px 8px; background: ${user.can_upload_gifs ? '#2196F3' : '#666'}; border-radius: 12px; font-size: 11px;">
                    ${user.can_upload_gifs ? 'Allowed' : 'Not Allowed'}
                </span>
            </td>
            <td>${user.last_active ? new Date(user.last_active).toLocaleDateString() : 'Never'}</td>
            <td>
                <div class="table-actions">
                    <button class="table-btn edit-btn" onclick="editUser('${user.id}')">Edit</button>
                    <button class="table-btn delete-btn" onclick="showDeleteModal('user', '${user.id}')">Delete</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function filterUsers() {
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    const filterBy = document.getElementById('userFilter').value;

    let filtered = allUsers.filter(user => {
        if (!user) return false;
        
        // Search filter
        const searchMatch = 
            user.username.toLowerCase().includes(searchTerm) ||
            user.email.toLowerCase().includes(searchTerm) ||
            user.id.toLowerCase().includes(searchTerm);
        
        if (!searchMatch) return false;
        
        // Additional filters
        switch(filterBy) {
            case 'verified':
                return user.verified;
            case 'unverified':
                return !user.verified;
            case 'gif_access':
                return user.can_upload_gifs;
            case 'uploaders':
                return user.uploads > 0;
            default:
                return true;
        }
    });

    displayUsersTable(filtered);
}

// Analytics Functions
async function loadAnalyticsData() {
    if (!adminLoggedIn) return;
    
    // Create sample charts for demo
    createUploadsOverTimeChart();
    createTypeDistributionChart();
    createTopServicesChart();
    createDailyViewsChart();
}

function createUploadsOverTimeChart() {
    const ctx = document.getElementById('uploadsOverTimeChart').getContext('2d');
    
    if (charts.uploadsOverTime) {
        charts.uploadsOverTime.destroy();
    }
    
    // Sample data
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
    const uploads = [12, 19, 8, 15, 22, 17];
    
    charts.uploadsOverTime = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'Uploads',
                data: uploads,
                backgroundColor: 'rgba(102, 126, 234, 0.7)',
                borderColor: '#667eea',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#888'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#888'
                    }
                }
            }
        }
    });
}

function createTypeDistributionChart() {
    const ctx = document.getElementById('typeDistributionChart').getContext('2d');
    
    if (charts.typeDistribution) {
        charts.typeDistribution.destroy();
    }
    
    charts.typeDistribution = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Images', 'GIFs/Videos'],
            datasets: [{
                data: [75, 25], // Sample data
                backgroundColor: ['#4CAF50', '#2196F3'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#ccc'
                    }
                }
            }
        }
    });
}

function createTopServicesChart() {
    const ctx = document.getElementById('topServicesChart').getContext('2d');
    
    if (charts.topServices) {
        charts.topServices.destroy();
    }
    
    charts.topServices = new Chart(ctx, {
        type: 'horizontalBar',
        data: {
            labels: ['Discord', 'YouTube', 'TikTok', 'Instagram', 'Twitter'],
            datasets: [{
                label: 'Uploads',
                data: [45, 32, 28, 19, 12],
                backgroundColor: 'rgba(156, 39, 176, 0.7)',
                borderColor: '#9C27B0',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#888'
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#888'
                    }
                }
            }
        }
    });
}

function createDailyViewsChart() {
    const ctx = document.getElementById('dailyViewsChart').getContext('2d');
    
    if (charts.dailyViews) {
        charts.dailyViews.destroy();
    }
    
    // Sample data for last 7 days
    const days = [];
    const views = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
        views.push(Math.floor(Math.random() * 1000) + 500);
    }
    
    charts.dailyViews = new Chart(ctx, {
        type: 'line',
        data: {
            labels: days,
            datasets: [{
                label: 'Views',
                data: views,
                borderColor: '#FF9800',
                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#888'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#888'
                    }
                }
            }
        }
    });
}

// System Functions
async function loadSystemInfo() {
    if (!adminLoggedIn) return;
    
    try {
        // Check API status
        const startTime = Date.now();
        const { data: testData, error: testError } = await supabase
            .from('profile_pictures')
            .select('count', { count: 'exact', head: true });
        const responseTime = Date.now() - startTime;
        
        document.getElementById('apiStatus').textContent = testError ? '‚ùå Offline' : '‚úÖ Online';
        document.getElementById('apiStatus').style.color = testError ? '#ff4444' : '#4CAF50';
        document.getElementById('responseTime').textContent = `${responseTime}ms`;
        
        // Get total tables count (you might need to query information_schema)
        document.getElementById('totalTables').textContent = '4 tables'; // Hardcoded for demo
        
        // Calculate database size (rough estimate)
        const { count: totalImages } = await supabase
            .from('profile_pictures')
            .select('*', { count: 'exact', head: true });
        const estimatedSize = totalImages ? (totalImages * 0.5).toFixed(1) : '0';
        document.getElementById('dbSize').textContent = `${estimatedSize} MB`;
        
        // Get last backup time from localStorage
        const lastBackup = localStorage.getItem('lastBackupTime');
        document.getElementById('lastBackup').textContent = lastBackup || 'Never';
        
        // Calculate uptime (simulated)
        const startTimeStorage = localStorage.getItem('systemStartTime');
        if (!startTimeStorage) {
            localStorage.setItem('systemStartTime', new Date().toISOString());
            document.getElementById('uptime').textContent = 'Just started';
        } else {
            const uptimeMs = new Date() - new Date(startTimeStorage);
            const hours = Math.floor(uptimeMs / (1000 * 60 * 60));
            const minutes = Math.floor((uptimeMs % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;
        }
        
    } catch (error) {
        console.error('Error loading system info:', error);
    }
}

// Logs Functions
async function loadLogsData() {
    if (!adminLoggedIn) return;
    
    try {
        // For demo, create sample logs
        // In production, you'd fetch from a logs table
        const sampleLogs = [
            {
                timestamp: new Date().toISOString(),
                level: 'info',
                type: 'upload',
                user: 'user_abc123',
                action: 'Image uploaded',
                details: 'New image uploaded with ID 123'
            },
            {
                timestamp: new Date(Date.now() - 3600000).toISOString(),
                level: 'warning',
                type: 'user',
                user: 'user_def456',
                action: 'Failed login attempt',
                details: 'Invalid password attempt'
            },
            {
                timestamp: new Date(Date.now() - 7200000).toISOString(),
                level: 'error',
                type: 'system',
                user: 'system',
                action: 'Database connection failed',
                details: 'Connection timeout'
            }
        ];
        
        allLogs = sampleLogs;
        displayLogsTable(allLogs);
        
    } catch (error) {
        console.error('Error loading logs:', error);
    }
}

function displayLogsTable(logs) {
    const tbody = document.getElementById('logsTableBody');
    
    if (!logs || logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No logs found</td></tr>';
        return;
    }

    tbody.innerHTML = logs.map(log => `
        <tr>
            <td>${new Date(log.timestamp).toLocaleString()}</td>
            <td>
                <span style="padding: 2px 8px; background: ${
                    log.level === 'error' ? '#ff4444' : 
                    log.level === 'warning' ? '#FF9800' : '#4CAF50'
                }; border-radius: 12px; font-size: 11px;">
                    ${log.level.toUpperCase()}
                </span>
            </td>
            <td>${log.type}</td>
            <td>${log.user.substring(0, 8)}...</td>
            <td>${log.action}</td>
            <td>${log.details}</td>
        </tr>
    `).join('');
}

function filterLogs() {
    const levelFilter = document.getElementById('logLevel').value;
    const typeFilter = document.getElementById('logType').value;
    const dateFilter = document.getElementById('logDate').value;

    let filtered = allLogs.filter(log => {
        if (!log) return false;
        
        // Level filter
        if (levelFilter !== 'all' && log.level !== levelFilter) return false;
        
        // Type filter
        if (typeFilter !== 'all' && log.type !== typeFilter) return false;
        
        // Date filter
        if (dateFilter) {
            const logDate = new Date(log.timestamp).toDateString();
            const filterDate = new Date(dateFilter).toDateString();
            if (logDate !== filterDate) return false;
        }
        
        return true;
    });

    displayLogsTable(filtered);
}

// Modal Functions
function showModal(modalId) {
    currentModal = modalId;
    document.getElementById(modalId).style.display = 'flex';
}

function hideModal() {
    if (currentModal) {
        document.getElementById(currentModal).style.display = 'none';
        currentModal = null;
    }
}

let deleteType = null;
let deleteId = null;

function showDeleteModal(type, id) {
    deleteType = type;
    deleteId = id;
    
    const modalText = document.getElementById('deleteModalText');
    if (type === 'image') {
        modalText.textContent = `Are you sure you want to delete image #${id}? This action cannot be undone.`;
    } else if (type === 'user') {
        modalText.textContent = `Are you sure you want to delete user ${id.substring(0, 8)}...?`;
    }
    
    showModal('deleteModal');
}

async function confirmDelete() {
    if (!deleteType || !deleteId) return;
    
    try {
        if (deleteType === 'image') {
            // Delete image and associated ratings
            const { error: ratingsError } = await supabase
                .from('user_ratings')
                .delete()
                .eq('image_id', deleteId);
            
            const { error: imageError } = await supabase
                .from('profile_pictures')
                .delete()
                .eq('id', deleteId);
            
            if (imageError) throw imageError;
            
            alert('Image deleted successfully');
            logAction('system', `Deleted image ${deleteId}`);
            
        } else if (deleteType === 'user') {
            // Delete user from verified_users
            const { error } = await supabase
                .from('verified_users')
                .delete()
                .eq('user_id', deleteId);
            
            if (error) throw error;
            
            alert('User deleted successfully');
            logAction('system', `Deleted user ${deleteId.substring(0, 8)}...`);
        }
        
        hideModal();
        
        // Refresh data
        if (deleteType === 'image') {
            loadImagesData();
            loadDashboardData();
        } else if (deleteType === 'user') {
            loadUsersData();
        }
        
    } catch (error) {
        console.error('Error deleting:', error);
        alert('Failed to delete. Please try again.');
    }
}

// Edit Image
async function editImage(imageId) {
    currentEditImageId = imageId;
    const image = allImages.find(img => img.id === imageId);
    
    if (!image) return;
    
    document.getElementById('editKeywords').value = image.keywords || '';
    document.getElementById('editService').value = image.service || '';
    document.getElementById('editType').value = image.type || 'image';
    document.getElementById('editViews').value = image.views || 0;
    document.getElementById('editRating').value = image.rating || 0;
    
    showModal('editImageModal');
}

async function saveImageEdit() {
    if (!currentEditImageId) return;
    
    try {
        const updates = {
            keywords: document.getElementById('editKeywords').value,
            service: document.getElementById('editService').value,
            type: document.getElementById('editType').value,
            views: parseInt(document.getElementById('editViews').value) || 0,
            rating: parseFloat(document.getElementById('editRating').value) || 0,
            updated_at: new Date().toISOString()
        };
        
        const { error } = await supabase
            .from('profile_pictures')
            .update(updates)
            .eq('id', currentEditImageId);
        
        if (error) throw error;
        
        alert('Image updated successfully');
        hideModal();
        loadImagesData();
        logAction('system', `Edited image ${currentEditImageId}`);
        
    } catch (error) {
        console.error('Error updating image:', error);
        alert('Failed to update image.');
    }
}

// Add New User
function addNewUser() {
    showModal('addUserModal');
}

async function saveNewUser() {
    try {
        const userId = document.getElementById('newUserId').value || 
                      'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        const username = document.getElementById('newUsername').value;
        const email = document.getElementById('newUserEmail').value;
        const gifAccess = document.getElementById('newUserGifAccess').value === 'true';
        const verified = document.getElementById('newUserVerified').value === 'true';
        
        if (!username || !email) {
            alert('Username and email are required.');
            return;
        }
        
        const { error } = await supabase
            .from('verified_users')
            .insert([{
                user_id: userId,
                username: username,
                email: email,
                can_upload_gifs: gifAccess,
                verified_at: verified ? new Date().toISOString() : null
            }]);
        
        if (error) {
            if (error.code === '23505') { // Unique constraint violation
                alert('User with this ID or email already exists.');
                return;
            }
            throw error;
        }
        
        alert('User added successfully');
        hideModal();
        loadUsersData();
        logAction('system', `Added new user: ${username}`);
        
    } catch (error) {
        console.error('Error adding user:', error);
        alert('Failed to add user.');
    }
}

// Selection Functions
function toggleImageSelection(imageId, isChecked) {
    if (isChecked) {
        selectedImages.add(imageId);
    } else {
        selectedImages.delete(imageId);
    }
}

function selectAllImages() {
    selectedImages.clear();
    allImages.forEach(img => selectedImages.add(img.id));
    document.querySelectorAll('#imagesTableBody input[type="checkbox"]').forEach(cb => cb.checked = true);
}

function deselectAllImages() {
    selectedImages.clear();
    document.querySelectorAll('#imagesTableBody input[type="checkbox"]').forEach(cb => cb.checked = false);
}

async function deleteSelectedImages() {
    if (selectedImages.size === 0) {
        alert('No images selected.');
        return;
    }
    
    if (!confirm(`Delete ${selectedImages.size} selected images? This cannot be undone.`)) {
        return;
    }
    
    try {
        const imageIds = Array.from(selectedImages);
        
        // Delete ratings first
        await supabase
            .from('user_ratings')
            .delete()
            .in('image_id', imageIds);
        
        // Delete images
        const { error } = await supabase
            .from('profile_pictures')
            .delete()
            .in('id', imageIds);
        
        if (error) throw error;
        
        alert(`${selectedImages.size} images deleted successfully.`);
        selectedImages.clear();
        loadImagesData();
        loadDashboardData();
        logAction('system', `Deleted ${selectedImages.size} images`);
        
    } catch (error) {
        console.error('Error deleting images:', error);
        alert('Failed to delete images.');
    }
}

// Export Functions
function exportImagesData() {
    // Create CSV content
    let csv = 'ID,Keywords,Service,Type,Views,Rating,Uploaded,User ID\n';
    
    allImages.forEach(image => {
        csv += `"${image.id}","${image.keywords || ''}","${image.service || ''}","${image.type || 'image'}","${image.views || 0}","${image.rating || 0}","${new Date(image.created_at).toLocaleString()}","${image.user_id || ''}"\n`;
    });
    
    // Create download link
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `images_export_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    logAction('system', 'Exported images data');
}

function exportUsersData() {
    let csv = 'User ID,Username,Email,Status,GIF Access,Uploads,Total Views,Last Active\n';
    
    allUsers.forEach(user => {
        csv += `"${user.id}","${user.username}","${user.email}","${user.verified ? 'Verified' : 'Unverified'}","${user.can_upload_gifs ? 'Allowed' : 'Not Allowed'}","${user.uploads || 0}","${user.total_views || 0}","${user.last_active || ''}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    logAction('system', 'Exported users data');
}

// Utility Functions
function logAction(type, action) {
    console.log(`[${type}] ${action}`);
    // In production, save to logs table
}

function refreshDashboard() {
    loadDashboardData();
    alert('Dashboard refreshed!');
}

// System Actions
function clearCache() {
    localStorage.removeItem('lastBackupTime');
    localStorage.removeItem('systemStartTime');
    alert('Cache cleared! System will restart.');
    logAction('system', 'Cache cleared');
    setTimeout(() => window.location.reload(), 1000);
}

function optimizeDatabase() {
    alert('Database optimization started. This may take a moment.');
    logAction('system', 'Database optimization initiated');
    // In production, call backend API
}

function backupDatabase() {
    const backupTime = new Date().toISOString();
    localStorage.setItem('lastBackupTime', backupTime);
    alert(`Backup created at ${new Date(backupTime).toLocaleString()}`);
    logAction('system', 'Database backup created');
}

function showSystemLogs() {
    switchTab('logs-tab');
}

function exportLogs() {
    let csv = 'Timestamp,Level,Type,User,Action,Details\n';
    
    allLogs.forEach(log => {
        csv += `"${new Date(log.timestamp).toLocaleString()}","${log.level}","${log.type}","${log.user}","${log.action}","${log.details}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `logs_export_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function clearOldLogs() {
    if (confirm('Clear all logs older than 30 days?')) {
        // In production, delete from database
        alert('Old logs cleared.');
        logAction('system', 'Cleared old logs');
        loadLogsData();
    }
}

// Export other data functions
function exportDashboardData() {
    alert('Dashboard data export feature would be implemented here.');
}

function exportAnalyticsData() {
    alert('Analytics data export feature would be implemented here.');
}

function generateReport() {
    alert('Report generation feature would be implemented here.');
}
</script>
</body>
</html>
